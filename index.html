<html>
  <head>
  </head>
  <body>
    <div id="parent" style="position:relative; cursor:none;">
     <canvas id="canvas0" width="1024" height="768" style="border:1px solid lightgrey; background-color:red; position:absolute; left:0px; top:0px; z-index:1;"></canvas>		
     <canvas id="canvas1" width="1024" height="768" style="border:1px solid lightgrey; background-color:transparent; position:absolute; left:0px; top:0px; z-index:2;"></canvas>	
     <canvas id="canvas2" width="1024" height="768" style="border:1px solid lightgrey; background-color:transparent; position:absolute; left:0px; top:0px; z-index:3;"></canvas>
     <canvas id="canvas3" width="1024" height="768" style="border:1px solid lightgrey; background-color:transparent; position:absolute; left:0px; top:0px; z-index:4;"></canvas>
     <canvas id="canvas4" width="1024" height="768" style="border:1px solid lightgrey; background-color:transparent; position:absolute; left:0px; top:0px; z-index:5;"></canvas>
     <canvas id="canvas5" width="1024" height="768" style="border:1px solid lightgrey; background-color:transparent; position:absolute; left:0px; top:0px; z-index:6;"></canvas>
     <canvas id="canvas6" width="1024" height="768" style="border:1px solid lightgrey; background-color:transparent; position:absolute; left:0px; top:0px; z-index:7;"></canvas>
     <canvas id="canvas7" width="1024" height="768" style="border:1px solid lightgrey; background-color:transparent; position:absolute; left:0px; top:0px; z-index:8;"></canvas>
     <canvas id="canvas8" width="1024" height="768" style="border:1px solid lightgrey; background-color:transparent; position:absolute; left:0px; top:0px; z-index:9;"></canvas>
     <canvas id="canvas9" width="1024" height="768" style="border:1px solid lightgrey; background-color:transparent; position:absolute; left:0px; top:0px; z-index:10;"></canvas>	
     <canvas id="canvas10" width="1024" height="768" style="border:1px solid lightgrey; background-color:transparent; position:absolute; left:0px; top:0px; z-index:11;"></canvas>
     <canvas id="canvas11" width="1024" height="768" style="border:1px solid lightgrey; background-color:transparent; position:absolute; left:0px; top:0px; z-index:12;"></canvas>
     <canvas id="canvas12" width="1024" height="768" style="border:1px solid lightgrey; background-color:transparent; position:absolute; left:0px; top:0px; z-index:13;"></canvas>
     <canvas id="canvas13" width="1024" height="768" style="border:1px solid lightgrey; background-color:transparent; position:absolute; left:0px; top:0px; z-index:14;"></canvas>
     <canvas id="canvas14" width="1024" height="768" style="border:1px solid lightgrey; background-color:transparent; position:absolute; left:0px; top:0px; z-index:15;"></canvas>
     <canvas id="canvas15" width="1024" height="768" style="border:1px solid lightgrey; background-color:transparent; position:absolute; left:0px; top:0px; z-index:16;"></canvas>
     <canvas id="canvas16" width="1024" height="768" style="border:1px solid lightgrey; background-color:transparent; position:absolute; left:0px; top:0px; z-index:17;"></canvas>
     <canvas id="canvas17" width="1024" height="768" style="border:1px solid lightgrey; background-color:transparent; position:absolute; left:0px; top:0px; z-index:18;"></canvas>
    </div>
    <script>
      //declaration
      var numCanvases = 16;
      var canvasBag = [];
      var contextBag = [];
      var startTime;
      var spawnClock = 0;
      var playerCanvas;
      var playerContext;
      var player;
      var canvasObjects = [];

      class GameObject
      {
        constructor(context, xPos, yPos, zPos, xVel, yVel, zVel)
        {
          this.context = context;
          this.xPos = xPos;
          this.yPos = yPos; 
          this.zPos = zPos; 
          this.xVel = xVel;
          this.yVel = yVel;
          this.zVel = zVel;
          this.isColliding = false;
        }
      }

      class Entity extends GameObject
      {
        constructor(context, xPos, yPos, zPos, xVel, yVel, zVel, scale, density)
        {
          super(context, xPos, yPos, zPos, xVel, yVel, zVel);
          this.scale = scale;
          this.density = density;
        }
        draw()
        {
          for(var i = 0; i < numCanvases; i++)
          {
          var num = 16*i;
          var color = '#' + num.toString(16) + '0000';
          if(this.context==contextBag[numCanvases-1-i]){this.context.fillStyle = color;}
          } 
          this.context.beginPath();
          this.context.arc(this.xPos, this.yPos, this.scale, 0, 2*Math.PI);
          this.context.fill();
        }
        update(seconds)
        {
          if(this.xVel != 0){this.xVel*=0.999;}
          if(this.yVel != 0){this.yVel*=0.999;}
          this.yVel += 0.1;
          this.xPos += this.xVel*seconds;
          this.yPos += this.yVel*seconds;
          this.zPos += this.zVel*seconds;
        }
      }
      class Player
      {
        constructor(context, xPos, yPos, scale)
        {
          this.context=context;
          this.xPos=xPos;
          this.yPos=yPos;
          this.scale=scale;
        }
        draw()
        {
          this.context.fillStyle = '#00FF00';
          this.context.beginPath();
          this.context.arc(this.xPos, this.yPos, this.scale, 0, 2*Math.PI);
          this.context.fill();          
        }
        update()
        {
          this.yPos=playerCanvas.height - this.scale; 
        }
      } 
      
      function makeCanvases(amount)
      {
        for(var i=0; i < amount; i++)
        {
          var temp;
          canvasBag[i] = temp;
        }
      }
      function makeContexts(amount)
      {
        for(var i=0; i < amount; i++)
        {
          var temp;
          contextBag[i] = temp;
        }
      }

      function linkContexts(amount)
      {
        for(var i=0; i < amount; i++)
        {
          var temp = 'canvas' + (i+1).toString();
          canvasBag[i] = document.getElementById(temp);
          contextBag[i] = canvasBag[i].getContext('2d');
        }
      }
      function makeLayers(amount)
      {
        for(var i=0; i < amount; i++)
        {
          var temp = [];
          canvasObjects.push(temp);
        }
      }
      function init()
      { 
        makeCanvases(numCanvases);
        makeContexts(numCanvases);
        linkContexts(numCanvases);
        makeLayers(numCanvases);
        playerCanvas = document.getElementById('canvas17');
        playerContext = playerCanvas.getContext('2d');
        player = new Player(playerContext, (playerCanvas.width)/2, playerCanvas.height - 20, 20);
        document.addEventListener("mousemove", mouseMoveHandler, false);
        document.addEventListener("click", fire, false);
        window.requestAnimationFrame(gameLoop);
      }

      window.onload = init(); //initialize on window load

      function mouseMoveHandler(e)
      {
        var relX = e.clientX - playerCanvas.offsetLeft;
        if(relX > player.scale && relX < playerCanvas.width - player.scale){player.xPos = relX;}
      }
      function fire()
      {
        var spawn = new Entity(contextBag[15], player.xPos, player.yPos-40, 100, 0, -750, 0, 10, 200);
        canvasObjects[15].push(spawn);
      }
      function gameLoop(currentTime)
      {
        var seconds = (currentTime - startTime)/1000;
        var framesPerSec = Math.round(1/seconds);
        startTime = currentTime;
        
        cleanUpLoop();

        spawnClock++
        if(spawnClock==2)
        {
          spawnerLoop();
          spawnClock = 0;
        }
        player.update();
        updateLoop(seconds);

        collisionLoop();

        moveInZLoop();

        clearCanvases();
        player.draw();
        drawLoop();

        contextBag[15].font = '25px Arial';
        contextBag[15].fillStyle = 'black';
        contextBag[15].fillText("fps: " + framesPerSec, 10, 30);

        window.requestAnimationFrame(gameLoop);
      }

      function spawnToCollide(spawnXPos,spawnYPos,sizeToSpawn,objects)
      {
        var obj1;
        var obj2;
        var willCollide = false;
        
        for(i=0; i < objects.length;i++)
        {
          obj1 = objects[i];
          var diffX = spawnXPos-obj1.xPos;
          var diffY = spawnYPos-obj1.yPos;
          var sqDistance= Math.pow(diffX,2) + Math.pow(diffY,2);
          if (sqDistance <= Math.pow(obj1.scale + sizeToSpawn,2))
          {
              willCollide = true;
          }
        }
        return willCollide;
      } 

      var spawner = function(objects)
      {
        var randomX = Math.floor(Math.random() * 1024);
        var randomY = Math.floor((Math.random() * 768)-10);
        var randomZ;
        var ranXVel = Math.floor(Math.random() * 250)-125;
        var ranYVel = Math.floor(Math.random() * 200)-100;
        var ranZVel = Math.random() * 4;
        var ranSize = Math.floor(Math.random() * 90) + 10;
        var ranDensity = Math.floor(Math.random() * 50) + 1;
        var currentContext;
        if(objects==canvasObjects[15])
        {
          currentContext = contextBag[15]; randomZ = Math.floor(Math.random() * 5 + 100);
        }
        else
        {
          for(var i=0; i < canvasObjects.length-1;i++)
          {
            if(objects==canvasObjects[i])
            {
              currentContext = contextBag[i]; randomZ = Math.floor(Math.random() * 5) + ((i+1)*5);
            }
          }
        }
        if(!spawnToCollide(randomX, randomY, ranSize, objects))
        {
          var spawn = new Entity(currentContext, randomX, randomY, randomZ, ranXVel, ranYVel, ranZVel, ranSize, ranDensity);
          objects.push(spawn);
        }
      }

      function spawnerLoop()
      {
        var ranCanvas = Math.floor(Math.random() * 5);
        spawner(canvasObjects[ranCanvas]);
      }

      function cleanUpOffScreen(objects)
      {
        for(i=0; i < objects.length; i++)
        {
          var obj = objects[i];
          if((obj.xPos-obj.scale)>canvasBag[0].width||
             (obj.xPos+obj.scale)<0||
             (obj.yPos-obj.scale)>canvasBag[0].height||
             (obj.yPos+obj.scale*10)<0)
          {objects.splice(i,1);}
        }
      }

      function cleanUpLoop()
      {
        for(var i=0;i<canvasObjects.length;i++)
        { 
           cleanUpOffScreen(canvasObjects[i]);
        }
      }

      function updateLoop(delta)
      {
        for(var i=0; i < canvasObjects.length; i++)
        {
          group = canvasObjects[i];
          for(var j=0; j < group.length; j++)
          {
            group[j].update(delta);
          }  
        }
      }
      function moveInZ(objects)
      {
        for(var i = 0; i < objects.length; i++)
        {               
          for(var j = 0; j < canvasObjects.length; j++)
          {
            if(objects[i].zPos < (j+1)*5 && (j+1)*5 < 80)
            {
              objects[i].context = contextBag[j];
              canvasObjects[j].push(objects[i]);
              objects.splice(i,1);
              j = canvasObjects.length;
            }
            else if(objects[i].zPos >= 75)
            {
              objects[i].context = contextBag[15];
              canvasObjects[15].push(objects[i]);
              objects.splice(i,1);
              j = canvasObjects.length;
            }
          }
        }              
      }
      function moveInZLoop()
      {
        for(var i=0; i < canvasObjects.length;i++)
        {
          moveInZ(canvasObjects[i]);
        }
      }
      function detectCollision(objects)
      {
        var obj1;
        var obj2;
        
        for(i=0; i < objects.length;i++)
        {
          objects[i].isColliding = false;
        }

        for(i=0; i < objects.length;i++)
        {
          obj1 = objects[i];
          for(j=i+1; j < objects.length;j++)
          {
            obj2 = objects[j];
            var deltaX = obj2.xPos-obj1.xPos;
            var deltaY = obj2.yPos-obj1.yPos;
            var sqDistance= Math.pow(deltaX,2) + Math.pow(deltaY,2);
            if(sqDistance <= (Math.pow(obj1.scale + obj2.scale,2)))
            {
              obj1.isColliding=true;
              obj2.isColliding=true;
              var vNorm = {x: deltaX/Math.sqrt(sqDistance), y: deltaY/Math.sqrt(sqDistance)};
              var vRelVel = {x: obj1.xVel-obj2.xVel, y: obj1.yVel-obj2.yVel};
              var speed = (vRelVel.x * vNorm.x) + (vRelVel.y * vNorm.y);
              if (speed < 0){break;}
              var impulse = 2* speed / ((obj1.scale*obj1.density) + (obj2.scale*obj2.density));
              obj1.xVel -= (impulse*obj2.scale*obj2.density*vNorm.x);
              obj1.yVel -= (impulse*obj2.scale*obj2.density*vNorm.y);
              obj2.xVel += (impulse*obj1.scale*obj1.density*vNorm.x);
              obj2.yVel += (impulse*obj1.scale*obj1.density*vNorm.y);
            }
          }
        }
      }
      function collisionLoop()
      {
        for(var i=0; i < canvasObjects.length;i++)
        {
          detectCollision(canvasObjects[i]);
        }
      }
      function clearCanvases()
      {
        for(i=0; i < contextBag.length; i++)
        {
          contextBag[i].clearRect(0,0,canvasBag[i].width,canvasBag[i].height);
        }
        playerContext.clearRect(0,0,playerCanvas.width,playerCanvas.height);
      }
      function drawLoop()
      {
        for(var i=0; i < canvasObjects.length; i++)
        {
          group = canvasObjects[i];
          for(var j=0; j < group.length; j++)
          {
            group[j].draw();
          }  
        }
      }
</script>
		
  </body>
</html>
